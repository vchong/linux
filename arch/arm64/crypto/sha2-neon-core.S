/*
 * sha2-neon-core.S - core SHA-224/SHA-256 transform using v8 Crypto Extensions
 *
 * Copyright (C) 2016 Linaro Ltd <daniel.thompson@linaro.org>
 * Copyright (C) 2016 Linaro Ltd <victor.chong@linaro.org>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 */

//ldmia, stmia no equivs in aarch64!

#include <linux/linkage.h>
#include <asm/assembler.h>

	.text
	.arch	armv8-a+simd

	/*
	 * The SHA-256 round constants
	 */
	.align	4
.Lsha2_rcon:
	.word	0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5
	.word	0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5
	.word	0xd807aa98,0x12835b01,0x243185be,0x550c7dc3
	.word	0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174
	.word	0xe49b69c1,0xefbe4786,0x0fc19dc6,0x240ca1cc
	.word	0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da
	.word	0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7
	.word	0xc6e00bf3,0xd5a79147,0x06ca6351,0x14292967
	.word	0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13
	.word	0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85
	.word	0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3
	.word	0xd192e819,0xd6990624,0xf40e3585,0x106aa070
	.word	0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5
	.word	0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3
	.word	0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208
	.word	0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2

	/*
	 * void sha256_block_data_order_neon(u32 *digest, const void *data,
	 *					     unsigned int num_blks);
	 */
	/*
	 * void sha2_neon_transform(struct sha256_ce_state *sst, u8 const *src,
	 *			  int blocks)
	 */
ENTRY(sha256_neon_transform)
	stmdb	sp!,{r4-r12,lr}

	sub	w11,sp,#16*4+16
	adrl	w14,.Lsha2_rcon
	bic	w11,w11,#15		@ align for 128-bit stores
	mov	w12,sp
	mov	sp,w11			@ alloca
	add	w2,x1,w2,lsl#6	@ len to point at the end of inp

	ld1.8		{q0},[x1]!
	ld1.8		{q1},[x1]!
	ld1.8		{q2},[x1]!
	ld1.8		{q3},[x1]!
	ld1.32		{q8},[w14,:128]!
	ld1.32		{q9},[w14,:128]!
	ld1.32		{q10},[w14,:128]!
	ld1.32		{q11},[w14,:128]!
	rev32.8	q0,q0		@ yes, even on
	str		x0,[sp,#64]
	rev32.8	q1,q1		@ big-endian
	str		x1,[sp,#68]
	mov		w1,sp
	rev32.8	q2,q2
	str		w2,[sp,#72]
	rev32.8	q3,q3
	str		w12,[sp,#76]		@ save original sp
	add.i32	q8,q8,q0
	add.i32	q9,q9,q1
	st1.32		{q8},[w1,:128]!
	add.i32	q10,q10,q2
	st1.32		{q9},[w1,:128]!
	add.i32	q11,q11,q3
	st1.32		{q10},[w1,:128]!
	st1.32		{q11},[w1,:128]!

	ldmia		x0,{w4-w11}
	sub		w1,w1,#64
	ldr		w2,[sp,#0]
	eor		w12,w12,w12
	eor		w3,w5,w6
	b		.L_00_48

.align	4
.L_00_48:
	ext.8	q8,q0,q1,#4
	add	w11,w11,w2
	eor	w2,w9,w10
	eor	w0,w8,w8,ror#5
	ext.8	q9,q2,q3,#4
	add	w4,w4,w12
	and	w2,w2,w8
	eor	w12,w0,w8,ror#19
	shr.u32	q10,q8,#7
	eor	w0,w4,w4,ror#11
	eor	w2,w2,w10
	add.i32	q0,q0,q9
	add	w11,w11,w12,ror#6
	eor	w12,w4,w5
	shr.u32	q9,q8,#3
	eor	w0,w0,w4,ror#20
	add	w11,w11,w2
	sli.32	q10,q8,#25
	ldr	w2,[sp,#4]
	and	w3,w3,w12
	shr.u32	q11,q8,#18
	add	w7,w7,w11
	add	w11,w11,w0,ror#2
	eor	w3,w3,w5
	eor	q9,q9,q10
	add	w10,w10,w2
	sli.32	q11,q8,#14
	eor	w2,w8,w9
	eor	w0,w7,w7,ror#5
	shr.u32	d24,d7,#17
	add	w11,w11,w3
	and	w2,w2,w7
	eor	q9,q9,q11
	eor	w3,w0,w7,ror#19
	eor	w0,w11,w11,ror#11
	sli.32	d24,d7,#15
	eor	w2,w2,w9
	add	w10,w10,w3,ror#6
	shr.u32	d25,d7,#10
	eor	w3,w11,w4
	eor	w0,w0,w11,ror#20
	add.i32	q0,q0,q9
	add	w10,w10,w2
	ldr	w2,[sp,#8]
	eor	d25,d25,d24
	and	w12,w12,w3
	add	w6,w6,w10
	shr.u32	d24,d7,#19
	add	w10,w10,w0,ror#2
	eor	w12,w12,w4
	sli.32	d24,d7,#13
	add	w9,w9,w2
	eor	w2,w7,w8
	eor	d25,d25,d24
	eor	w0,w6,w6,ror#5
	add	w10,w10,w12
	add.i32	d0,d0,d25
	and	w2,w2,w6
	eor	w12,w0,w6,ror#19
	shr.u32	d24,d0,#17
	eor	w0,w10,w10,ror#11
	eor	w2,w2,w8
	sli.32	d24,d0,#15
	add	w9,w9,w12,ror#6
	eor	w12,w10,w11
	shr.u32	d25,d0,#10
	eor	w0,w0,w10,ror#20
	add	w9,w9,w2
	eor	d25,d25,d24
	ldr	w2,[sp,#12]
	and	w3,w3,w12
	shr.u32	d24,d0,#19
	add	w5,w5,w9
	add	w9,w9,w0,ror#2
	eor	w3,w3,w11
	ld1.32	{q8},[w14,:128]!
	add	w8,w8,w2
	sli.32	d24,d0,#13
	eor	w2,w6,w7
	eor	w0,w5,w5,ror#5
	eor	d25,d25,d24
	add	w9,w9,w3
	and	w2,w2,w5
	add.i32	d1,d1,d25
	eor	w3,w0,w5,ror#19
	eor	w0,w9,w9,ror#11
	add.i32	q8,q8,q0
	eor	w2,w2,w7
	add	w8,w8,w3,ror#6
	eor	w3,w9,w10
	eor	w0,w0,w9,ror#20
	add	w8,w8,w2
	ldr	w2,[sp,#16]
	and	w12,w12,w3
	add	w4,w4,w8
	st1.32	{q8},[w1,:128]!
	add	w8,w8,w0,ror#2
	eor	w12,w12,w10
	ext.8	q8,q1,q2,#4
	add	w7,w7,w2
	eor	w2,w5,w6
	eor	w0,w4,w4,ror#5
	ext.8	q9,q3,q0,#4
	add	w8,w8,w12
	and	w2,w2,w4
	eor	w12,w0,w4,ror#19
	shr.u32	q10,q8,#7
	eor	w0,w8,w8,ror#11
	eor	w2,w2,w6
	add.i32	q1,q1,q9
	add	w7,w7,w12,ror#6
	eor	w12,w8,w9
	shr.u32	q9,q8,#3
	eor	w0,w0,w8,ror#20
	add	w7,w7,w2
	sli.32	q10,q8,#25
	ldr	w2,[sp,#20]
	and	w3,w3,w12
	shr.u32	q11,q8,#18
	add	w11,w11,w7
	add	w7,w7,w0,ror#2
	eor	w3,w3,w9
	eor	q9,q9,q10
	add	w6,w6,w2
	sli.32	q11,q8,#14
	eor	w2,w4,w5
	eor	w0,w11,w11,ror#5
	shr.u32	d24,d1,#17
	add	w7,w7,w3
	and	w2,w2,w11
	eor	q9,q9,q11
	eor	w3,w0,w11,ror#19
	eor	w0,w7,w7,ror#11
	sli.32	d24,d1,#15
	eor	w2,w2,w5
	add	w6,w6,w3,ror#6
	shr.u32	d25,d1,#10
	eor	w3,w7,w8
	eor	w0,w0,w7,ror#20
	add.i32	q1,q1,q9
	add	w6,w6,w2
	ldr	w2,[sp,#24]
	eor	d25,d25,d24
	and	w12,w12,w3
	add	w10,w10,w6
	shr.u32	d24,d1,#19
	add	w6,w6,w0,ror#2
	eor	w12,w12,w8
	sli.32	d24,d1,#13
	add	w5,w5,w2
	eor	w2,w11,w4
	eor	d25,d25,d24
	eor	w0,w10,w10,ror#5
	add	w6,w6,w12
	add.i32	d2,d2,d25
	and	w2,w2,w10
	eor	w12,w0,w10,ror#19
	shr.u32	d24,d2,#17
	eor	w0,w6,w6,ror#11
	eor	w2,w2,w4
	sli.32	d24,d2,#15
	add	w5,w5,w12,ror#6
	eor	w12,w6,w7
	shr.u32	d25,d2,#10
	eor	w0,w0,w6,ror#20
	add	w5,w5,w2
	eor	d25,d25,d24
	ldr	w2,[sp,#28]
	and	w3,w3,w12
	shr.u32	d24,d2,#19
	add	w9,w9,w5
	add	w5,w5,w0,ror#2
	eor	w3,w3,w7
	ld1.32	{q8},[w14,:128]!
	add	w4,w4,w2
	sli.32	d24,d2,#13
	eor	w2,w10,w11
	eor	w0,w9,w9,ror#5
	eor	d25,d25,d24
	add	w5,w5,w3
	and	w2,w2,w9
	add.i32	d3,d3,d25
	eor	w3,w0,w9,ror#19
	eor	w0,w5,w5,ror#11
	add.i32	q8,q8,q1
	eor	w2,w2,w11
	add	w4,w4,w3,ror#6
	eor	w3,w5,w6
	eor	w0,w0,w5,ror#20
	add	w4,w4,w2
	ldr	w2,[sp,#32]
	and	w12,w12,w3
	add	w8,w8,w4
	st1.32	{q8},[w1,:128]!
	add	w4,w4,w0,ror#2
	eor	w12,w12,w6
	ext.8	q8,q2,q3,#4
	add	w11,w11,w2
	eor	w2,w9,w10
	eor	w0,w8,w8,ror#5
	ext.8	q9,q0,q1,#4
	add	w4,w4,w12
	and	w2,w2,w8
	eor	w12,w0,w8,ror#19
	shr.u32	q10,q8,#7
	eor	w0,w4,w4,ror#11
	eor	w2,w2,w10
	add.i32	q2,q2,q9
	add	w11,w11,w12,ror#6
	eor	w12,w4,w5
	shr.u32	q9,q8,#3
	eor	w0,w0,w4,ror#20
	add	w11,w11,w2
	sli.32	q10,q8,#25
	ldr	w2,[sp,#36]
	and	w3,w3,w12
	shr.u32	q11,q8,#18
	add	w7,w7,w11
	add	w11,w11,w0,ror#2
	eor	w3,w3,w5
	eor	q9,q9,q10
	add	w10,w10,w2
	sli.32	q11,q8,#14
	eor	w2,w8,w9
	eor	w0,w7,w7,ror#5
	shr.u32	d24,d3,#17
	add	w11,w11,w3
	and	w2,w2,w7
	eor	q9,q9,q11
	eor	w3,w0,w7,ror#19
	eor	w0,w11,w11,ror#11
	sli.32	d24,d3,#15
	eor	w2,w2,w9
	add	w10,w10,w3,ror#6
	shr.u32	d25,d3,#10
	eor	w3,w11,w4
	eor	w0,w0,w11,ror#20
	add.i32	q2,q2,q9
	add	w10,w10,w2
	ldr	w2,[sp,#40]
	eor	d25,d25,d24
	and	w12,w12,w3
	add	w6,w6,w10
	shr.u32	d24,d3,#19
	add	w10,w10,w0,ror#2
	eor	w12,w12,w4
	sli.32	d24,d3,#13
	add	w9,w9,w2
	eor	w2,w7,w8
	eor	d25,d25,d24
	eor	w0,w6,w6,ror#5
	add	w10,w10,w12
	add.i32	d4,d4,d25
	and	w2,w2,w6
	eor	w12,w0,w6,ror#19
	shr.u32	d24,d4,#17
	eor	w0,w10,w10,ror#11
	eor	w2,w2,w8
	sli.32	d24,d4,#15
	add	w9,w9,w12,ror#6
	eor	w12,w10,w11
	shr.u32	d25,d4,#10
	eor	w0,w0,w10,ror#20
	add	w9,w9,w2
	eor	d25,d25,d24
	ldr	w2,[sp,#44]
	and	w3,w3,w12
	shr.u32	d24,d4,#19
	add	w5,w5,w9
	add	w9,w9,w0,ror#2
	eor	w3,w3,w11
	ld1.32	{q8},[w14,:128]!
	add	w8,w8,w2
	sli.32	d24,d4,#13
	eor	w2,w6,w7
	eor	w0,w5,w5,ror#5
	eor	d25,d25,d24
	add	w9,w9,w3
	and	w2,w2,w5
	add.i32	d5,d5,d25
	eor	w3,w0,w5,ror#19
	eor	w0,w9,w9,ror#11
	add.i32	q8,q8,q2
	eor	w2,w2,w7
	add	w8,w8,w3,ror#6
	eor	w3,w9,w10
	eor	w0,w0,w9,ror#20
	add	w8,w8,w2
	ldr	w2,[sp,#48]
	and	w12,w12,w3
	add	w4,w4,w8
	st1.32	{q8},[w1,:128]!
	add	w8,w8,w0,ror#2
	eor	w12,w12,w10
	ext.8	q8,q3,q0,#4
	add	w7,w7,w2
	eor	w2,w5,w6
	eor	w0,w4,w4,ror#5
	ext.8	q9,q1,q2,#4
	add	w8,w8,w12
	and	w2,w2,w4
	eor	w12,w0,w4,ror#19
	shr.u32	q10,q8,#7
	eor	w0,w8,w8,ror#11
	eor	w2,w2,w6
	add.i32	q3,q3,q9
	add	w7,w7,w12,ror#6
	eor	w12,w8,w9
	shr.u32	q9,q8,#3
	eor	w0,w0,w8,ror#20
	add	w7,w7,w2
	sli.32	q10,q8,#25
	ldr	w2,[sp,#52]
	and	w3,w3,w12
	shr.u32	q11,q8,#18
	add	w11,w11,w7
	add	w7,w7,w0,ror#2
	eor	w3,w3,w9
	eor	q9,q9,q10
	add	w6,w6,w2
	sli.32	q11,q8,#14
	eor	w2,w4,w5
	eor	w0,w11,w11,ror#5
	shr.u32	d24,d5,#17
	add	w7,w7,w3
	and	w2,w2,w11
	eor	q9,q9,q11
	eor	w3,w0,w11,ror#19
	eor	w0,w7,w7,ror#11
	sli.32	d24,d5,#15
	eor	w2,w2,w5
	add	w6,w6,w3,ror#6
	shr.u32	d25,d5,#10
	eor	w3,w7,w8
	eor	w0,w0,w7,ror#20
	add.i32	q3,q3,q9
	add	w6,w6,w2
	ldr	w2,[sp,#56]
	eor	d25,d25,d24
	and	w12,w12,w3
	add	w10,w10,w6
	shr.u32	d24,d5,#19
	add	w6,w6,w0,ror#2
	eor	w12,w12,w8
	sli.32	d24,d5,#13
	add	w5,w5,w2
	eor	w2,w11,w4
	eor	d25,d25,d24
	eor	w0,w10,w10,ror#5
	add	w6,w6,w12
	add.i32	d6,d6,d25
	and	w2,w2,w10
	eor	w12,w0,w10,ror#19
	shr.u32	d24,d6,#17
	eor	w0,w6,w6,ror#11
	eor	w2,w2,w4
	sli.32	d24,d6,#15
	add	w5,w5,w12,ror#6
	eor	w12,w6,w7
	shr.u32	d25,d6,#10
	eor	w0,w0,w6,ror#20
	add	w5,w5,w2
	eor	d25,d25,d24
	ldr	w2,[sp,#60]
	and	w3,w3,w12
	shr.u32	d24,d6,#19
	add	w9,w9,w5
	add	w5,w5,w0,ror#2
	eor	w3,w3,w7
	ld1.32	{q8},[w14,:128]!
	add	w4,w4,w2
	sli.32	d24,d6,#13
	eor	w2,w10,w11
	eor	w0,w9,w9,ror#5
	eor	d25,d25,d24
	add	w5,w5,w3
	and	w2,w2,w9
	add.i32	d7,d7,d25
	eor	w3,w0,w9,ror#19
	eor	w0,w5,w5,ror#11
	add.i32	q8,q8,q3
	eor	w2,w2,w11
	add	w4,w4,w3,ror#6
	eor	w3,w5,w6
	eor	w0,w0,w5,ror#20
	add	w4,w4,w2
	ldr	w2,[w14]
	and	w12,w12,w3
	add	w8,w8,w4
	st1.32	{q8},[w1,:128]!
	add	w4,w4,w0,ror#2
	eor	w12,w12,w6
	teq	w2,#0				@ check for sha2_rcon terminator
	ldr	w2,[sp,#0]
	sub	w1,w1,#64
	bne	.L_00_48

	ldr		x1,[sp,#68]
	ldr		w0,[sp,#72]
	sub		w14,w14,#256	@ rewind w14
	teq		x1,w0
	it		eq
	subeq		x1,x1,#64		@ avoid SEGV
	ld1.8		{q0},[x1]!		@ load next input block
	ld1.8		{q1},[x1]!
	ld1.8		{q2},[x1]!
	ld1.8		{q3},[x1]!
	it		ne
	strne		x1,[sp,#68]
	mov		w1,sp
	add	w11,w11,w2
	eor	w2,w9,w10
	eor	w0,w8,w8,ror#5
	add	w4,w4,w12
	ld1.32	{q8},[w14,:128]!
	and	w2,w2,w8
	eor	w12,w0,w8,ror#19
	eor	w0,w4,w4,ror#11
	eor	w2,w2,w10
	rev32.8	q0,q0
	add	w11,w11,w12,ror#6
	eor	w12,w4,w5
	eor	w0,w0,w4,ror#20
	add	w11,w11,w2
	add.i32	q8,q8,q0
	ldr	w2,[sp,#4]
	and	w3,w3,w12
	add	w7,w7,w11
	add	w11,w11,w0,ror#2
	eor	w3,w3,w5
	add	w10,w10,w2
	eor	w2,w8,w9
	eor	w0,w7,w7,ror#5
	add	w11,w11,w3
	and	w2,w2,w7
	eor	w3,w0,w7,ror#19
	eor	w0,w11,w11,ror#11
	eor	w2,w2,w9
	add	w10,w10,w3,ror#6
	eor	w3,w11,w4
	eor	w0,w0,w11,ror#20
	add	w10,w10,w2
	ldr	w2,[sp,#8]
	and	w12,w12,w3
	add	w6,w6,w10
	add	w10,w10,w0,ror#2
	eor	w12,w12,w4
	add	w9,w9,w2
	eor	w2,w7,w8
	eor	w0,w6,w6,ror#5
	add	w10,w10,w12
	and	w2,w2,w6
	eor	w12,w0,w6,ror#19
	eor	w0,w10,w10,ror#11
	eor	w2,w2,w8
	add	w9,w9,w12,ror#6
	eor	w12,w10,w11
	eor	w0,w0,w10,ror#20
	add	w9,w9,w2
	ldr	w2,[sp,#12]
	and	w3,w3,w12
	add	w5,w5,w9
	add	w9,w9,w0,ror#2
	eor	w3,w3,w11
	add	w8,w8,w2
	eor	w2,w6,w7
	eor	w0,w5,w5,ror#5
	add	w9,w9,w3
	and	w2,w2,w5
	eor	w3,w0,w5,ror#19
	eor	w0,w9,w9,ror#11
	eor	w2,w2,w7
	add	w8,w8,w3,ror#6
	eor	w3,w9,w10
	eor	w0,w0,w9,ror#20
	add	w8,w8,w2
	ldr	w2,[sp,#16]
	and	w12,w12,w3
	add	w4,w4,w8
	add	w8,w8,w0,ror#2
	eor	w12,w12,w10
	st1.32	{q8},[w1,:128]!
	add	w7,w7,w2
	eor	w2,w5,w6
	eor	w0,w4,w4,ror#5
	add	w8,w8,w12
	ld1.32	{q8},[w14,:128]!
	and	w2,w2,w4
	eor	w12,w0,w4,ror#19
	eor	w0,w8,w8,ror#11
	eor	w2,w2,w6
	rev32.8	q1,q1
	add	w7,w7,w12,ror#6
	eor	w12,w8,w9
	eor	w0,w0,w8,ror#20
	add	w7,w7,w2
	add.i32	q8,q8,q1
	ldr	w2,[sp,#20]
	and	w3,w3,w12
	add	w11,w11,w7
	add	w7,w7,w0,ror#2
	eor	w3,w3,w9
	add	w6,w6,w2
	eor	w2,w4,w5
	eor	w0,w11,w11,ror#5
	add	w7,w7,w3
	and	w2,w2,w11
	eor	w3,w0,w11,ror#19
	eor	w0,w7,w7,ror#11
	eor	w2,w2,w5
	add	w6,w6,w3,ror#6
	eor	w3,w7,w8
	eor	w0,w0,w7,ror#20
	add	w6,w6,w2
	ldr	w2,[sp,#24]
	and	w12,w12,w3
	add	w10,w10,w6
	add	w6,w6,w0,ror#2
	eor	w12,w12,w8
	add	w5,w5,w2
	eor	w2,w11,w4
	eor	w0,w10,w10,ror#5
	add	w6,w6,w12
	and	w2,w2,w10
	eor	w12,w0,w10,ror#19
	eor	w0,w6,w6,ror#11
	eor	w2,w2,w4
	add	w5,w5,w12,ror#6
	eor	w12,w6,w7
	eor	w0,w0,w6,ror#20
	add	w5,w5,w2
	ldr	w2,[sp,#28]
	and	w3,w3,w12
	add	w9,w9,w5
	add	w5,w5,w0,ror#2
	eor	w3,w3,w7
	add	w4,w4,w2
	eor	w2,w10,w11
	eor	w0,w9,w9,ror#5
	add	w5,w5,w3
	and	w2,w2,w9
	eor	w3,w0,w9,ror#19
	eor	w0,w5,w5,ror#11
	eor	w2,w2,w11
	add	w4,w4,w3,ror#6
	eor	w3,w5,w6
	eor	w0,w0,w5,ror#20
	add	w4,w4,w2
	ldr	w2,[sp,#32]
	and	w12,w12,w3
	add	w8,w8,w4
	add	w4,w4,w0,ror#2
	eor	w12,w12,w6
	st1.32	{q8},[w1,:128]!
	add	w11,w11,w2
	eor	w2,w9,w10
	eor	w0,w8,w8,ror#5
	add	w4,w4,w12
	ld1.32	{q8},[w14,:128]!
	and	w2,w2,w8
	eor	w12,w0,w8,ror#19
	eor	w0,w4,w4,ror#11
	eor	w2,w2,w10
	rev32.8	q2,q2
	add	w11,w11,w12,ror#6
	eor	w12,w4,w5
	eor	w0,w0,w4,ror#20
	add	w11,w11,w2
	add.i32	q8,q8,q2
	ldr	w2,[sp,#36]
	and	w3,w3,w12
	add	w7,w7,w11
	add	w11,w11,w0,ror#2
	eor	w3,w3,w5
	add	w10,w10,w2
	eor	w2,w8,w9
	eor	w0,w7,w7,ror#5
	add	w11,w11,w3
	and	w2,w2,w7
	eor	w3,w0,w7,ror#19
	eor	w0,w11,w11,ror#11
	eor	w2,w2,w9
	add	w10,w10,w3,ror#6
	eor	w3,w11,w4
	eor	w0,w0,w11,ror#20
	add	w10,w10,w2
	ldr	w2,[sp,#40]
	and	w12,w12,w3
	add	w6,w6,w10
	add	w10,w10,w0,ror#2
	eor	w12,w12,w4
	add	w9,w9,w2
	eor	w2,w7,w8
	eor	w0,w6,w6,ror#5
	add	w10,w10,w12
	and	w2,w2,w6
	eor	w12,w0,w6,ror#19
	eor	w0,w10,w10,ror#11
	eor	w2,w2,w8
	add	w9,w9,w12,ror#6
	eor	w12,w10,w11
	eor	w0,w0,w10,ror#20
	add	w9,w9,w2
	ldr	w2,[sp,#44]
	and	w3,w3,w12
	add	w5,w5,w9
	add	w9,w9,w0,ror#2
	eor	w3,w3,w11
	add	w8,w8,w2
	eor	w2,w6,w7
	eor	w0,w5,w5,ror#5
	add	w9,w9,w3
	and	w2,w2,w5
	eor	w3,w0,w5,ror#19
	eor	w0,w9,w9,ror#11
	eor	w2,w2,w7
	add	w8,w8,w3,ror#6
	eor	w3,w9,w10
	eor	w0,w0,w9,ror#20
	add	w8,w8,w2
	ldr	w2,[sp,#48]
	and	w12,w12,w3
	add	w4,w4,w8
	add	w8,w8,w0,ror#2
	eor	w12,w12,w10
	st1.32	{q8},[w1,:128]!
	add	w7,w7,w2
	eor	w2,w5,w6
	eor	w0,w4,w4,ror#5
	add	w8,w8,w12
	ld1.32	{q8},[w14,:128]!
	and	w2,w2,w4
	eor	w12,w0,w4,ror#19
	eor	w0,w8,w8,ror#11
	eor	w2,w2,w6
	rev32.8	q3,q3
	add	w7,w7,w12,ror#6
	eor	w12,w8,w9
	eor	w0,w0,w8,ror#20
	add	w7,w7,w2
	add.i32	q8,q8,q3
	ldr	w2,[sp,#52]
	and	w3,w3,w12
	add	w11,w11,w7
	add	w7,w7,w0,ror#2
	eor	w3,w3,w9
	add	w6,w6,w2
	eor	w2,w4,w5
	eor	w0,w11,w11,ror#5
	add	w7,w7,w3
	and	w2,w2,w11
	eor	w3,w0,w11,ror#19
	eor	w0,w7,w7,ror#11
	eor	w2,w2,w5
	add	w6,w6,w3,ror#6
	eor	w3,w7,w8
	eor	w0,w0,w7,ror#20
	add	w6,w6,w2
	ldr	w2,[sp,#56]
	and	w12,w12,w3
	add	w10,w10,w6
	add	w6,w6,w0,ror#2
	eor	w12,w12,w8
	add	w5,w5,w2
	eor	w2,w11,w4
	eor	w0,w10,w10,ror#5
	add	w6,w6,w12
	and	w2,w2,w10
	eor	w12,w0,w10,ror#19
	eor	w0,w6,w6,ror#11
	eor	w2,w2,w4
	add	w5,w5,w12,ror#6
	eor	w12,w6,w7
	eor	w0,w0,w6,ror#20
	add	w5,w5,w2
	ldr	w2,[sp,#60]
	and	w3,w3,w12
	add	w9,w9,w5
	add	w5,w5,w0,ror#2
	eor	w3,w3,w7
	add	w4,w4,w2
	eor	w2,w10,w11
	eor	w0,w9,w9,ror#5
	add	w5,w5,w3
	and	w2,w2,w9
	eor	w3,w0,w9,ror#19
	eor	w0,w5,w5,ror#11
	eor	w2,w2,w11
	add	w4,w4,w3,ror#6
	eor	w3,w5,w6
	eor	w0,w0,w5,ror#20
	add	w4,w4,w2
	ldr	w2,[sp,#64]
	and	w12,w12,w3
	add	w8,w8,w4
	add	w4,w4,w0,ror#2
	eor	w12,w12,w6
	st1.32	{q8},[w1,:128]!
	ldr	w0,[w2,#0]
	add	w4,w4,w12			@ h+=Maj(a,b,c) from the past
	ldr	w12,[w2,#4]
	ldr	w3,[w2,#8]
	ldr	w1,[w2,#12]
	add	w4,w4,w0			@ accumulate
	ldr	w0,[w2,#16]
	add	w5,w5,w12
	ldr	w12,[w2,#20]
	add	w6,w6,w3
	ldr	w3,[w2,#24]
	add	w7,w7,w1
	ldr	w1,[w2,#28]
	add	w8,w8,w0
	str	w4,[w2],#4
	add	w9,w9,w12
	str	w5,[w2],#4
	add	w10,w10,w3
	str	w6,[w2],#4
	add	w11,w11,w1
	str	w7,[w2],#4
	stmia	w2,{w8-w11}

	ittte	ne
	movne	w1,sp
	ldrne	w2,[sp,#0]
	eorne	w12,w12,w12
	ldreq	sp,[sp,#76]			@ restore original sp
	itt	ne
	eorne	w3,w5,w6
	bne	.L_00_48

	ldmia	sp!,{r4-r12,pc}
ENDPROC(sha256_neon_transform)
